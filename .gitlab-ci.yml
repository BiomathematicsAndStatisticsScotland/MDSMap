stages:
  - deps
  - roxygen
  - rcmdcheck
  - build

image: rocker/tidyverse

variables:
  RGL_USE_NULL: "true"

default:
  before_script:
    - mkdir -p installed_deps
    - echo 'R_LIBS="${CI_PROJECT_DIR}/installed_deps"' > ~/.Renviron
    - echo 'R_LIBS_USER="${CI_PROJECT_DIR}/installed_deps"' >> ~/.Renviron
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
     - installed_deps/

roxygen-job:
  stage: roxygen
  needs: ["deps-job"]
  script:
    - R -e "roxygen2::roxygenise(\"MDSMap\")"
  artifacts:
    paths:
      MDSMap

deps-job:
  stage: deps
  script:
    - cd MDSMap && R -e "remotes::install_deps(dependencies=TRUE)"
  artifacts:
    paths:
      MDSMap

rcmdcheck-job:
  stage: rcmdcheck
  needs: ["roxygen-job", "deps-job"]
  script:
    - R CMD check MDSMap --no-build-vignettes --no-manual
  artifacts:
    when: always
    paths:
      - MDSMap.Rcheck

